<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM для учёта клиентов</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out forwards;
        }
        
        .status-badge {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .status-badge:hover {
            transform: scale(1.05);
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .collapsible-content.expanded {
            max-height: 1000px;
        }
        
        .timeline-item:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 18px;
            top: 32px;
            height: calc(100% - 32px);
            width: 2px;
            background-color: #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Шапка приложения -->
        <header class="mb-6">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">
                    <i class="fas fa-users text-blue-500 mr-3"></i>
                    CRM light
                </h1>
                <button id="new-client-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center">
                    <i class="fas fa-plus mr-2"></i> Новый клиент
                </button>
            </div>
            <p class="text-gray-500 mt-2">Для учёта клиентов</p>
        </header>
        
        <!-- Основной контент -->
        <main>
            <!-- Фильтры и поиск -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden mb-6 fade-in">
                <div class="p-4 border-b border-gray-200">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-gray-700 text-sm mb-1">Статус</label>
                            <select id="status-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="all">Все</option>
                                <option value="new">Новый</option>
                                <option value="contacted">Контакт</option>
                                <option value="proposal">Предложение</option>
                                <option value="negotiation">Переговоры</option>
                                <option value="closed">Закрыт</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm mb-1">Источник</label>
                            <select id="source-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <option value="all">Все</option>
                                <option value="website">Сайт</option>
                                <option value="social">Соцсети</option>
                                <option value="recommendation">Рекомендация</option>
                                <option value="ad">Реклама</option>
                                <option value="other">Другое</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm mb-1">Дата с</label>
                            <input type="date" id="date-from" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        </div>
                        <div>
                            <label class="block text-gray-700 text-sm mb-1">Поиск</label>
                            <div class="relative">
                                <input type="text" id="search" placeholder="Имя, телефон, email..." class="w-full pl-3 pr-8 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                <i class="fas fa-search absolute right-3 top-2.5 text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Статистика -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6 fade-in">
                <div class="bg-white rounded-xl shadow-md p-4">
                    <div class="text-2xl font-bold text-blue-600" id="total-clients">0</div>
                    <div class="text-gray-600 text-sm">Всего клиентов</div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-4">
                    <div class="text-2xl font-bold text-green-600" id="new-clients">0</div>
                    <div class="text-gray-600 text-sm">Новые</div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-4">
                    <div class="text-2xl font-bold text-yellow-600" id="active-clients">0</div>
                    <div class="text-gray-600 text-sm">Активные</div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-4">
                    <div class="text-2xl font-bold text-purple-600" id="proposal-clients">0</div>
                    <div class="text-gray-600 text-sm">Предложения</div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-4">
                    <div class="text-2xl font-bold text-red-600" id="closed-clients">0</div>
                    <div class="text-gray-600 text-sm">Закрытые</div>
                </div>
            </div>
            
            <!-- Список клиентов -->
            <div class="bg-white rounded-xl shadow-md overflow-hidden fade-in">
                <div class="p-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-lg font-semibold text-gray-800">
                            <i class="fas fa-list-ul text-blue-500 mr-2"></i>
                            Список клиентов
                        </h2>
                        <div class="text-sm text-gray-500" id="clients-count">Показано 0 из 0</div>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Клиент</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Контакты</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Статус</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Источник</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Дата</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Действия</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200" id="clients-list">
                            <tr>
                                <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                    <i class="fas fa-inbox text-3xl mb-2"></i>
                                    <p>Нет клиентов</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Пагинация -->
                <div class="flex justify-between items-center p-4 border-t border-gray-200">
                    <button id="prev-page" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 disabled:opacity-50" disabled>
                        <i class="fas fa-chevron-left mr-2"></i> Назад
                    </button>
                    <span id="page-info" class="text-sm text-gray-600">Страница 1 из 1</span>
                    <button id="next-page" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 disabled:opacity-50" disabled>
                        Вперед <i class="fas fa-chevron-right ml-2"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Модальное окно добавления/редактирования клиента -->
    <div id="client-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto fade-in">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800" id="modal-title">Новый клиент</h3>
                <button id="close-client-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <form id="client-form">
                    <input type="hidden" id="client-id">
                    
                    <div class="grid gap-4 md:grid-cols-2">
                        <!-- Основная информация -->
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">Имя*</label>
                            <input type="text" id="client-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">Компания</label>
                            <input type="text" id="client-company" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">Телефон*</label>
                            <input type="tel" id="client-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-gray-700 mb-2">Email</label>
                            <input type="email" id="client-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div class="mb-4 md:col-span-2">
                            <label class="block text-gray-700 mb-2">Источник</label>
                            <select id="client-source" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="website">Сайт</option>
                                <option value="social">Соцсети</option>
                                <option value="recommendation">Рекомендация</option>
                                <option value="ad">Реклама</option>
                                <option value="other">Другое</option>
                            </select>
                        </div>
                        
                        <div class="mb-4 md:col-span-2">
                            <label class="block text-gray-700 mb-2">Статус</label>
                            <select id="client-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="new">Новый</option>
                                <option value="contacted">Контакт</option>
                                <option value="proposal">Предложение</option>
                                <option value="negotiation">Переговоры</option>
                                <option value="closed">Закрыт</option>
                            </select>
                        </div>
                        
                        <div class="mb-4 md:col-span-2">
                            <label class="block text-gray-700 mb-2">Заметки</label>
                            <textarea id="client-notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Дополнительная информация о клиенте"></textarea>
                        </div>
                    </div>
                    
                    <!-- Кнопки -->
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" id="cancel-client" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 flex items-center">
                            <i class="fas fa-times mr-2"></i> Отмена
                        </button>
                        <button type="submit" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center">
                            <i class="fas fa-save mr-2"></i> Сохранить
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Модальное окно просмотра клиента -->
    <div id="view-client-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto fade-in">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-800" id="view-client-name"></h3>
                <button id="close-view-client-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-6">
                <div class="grid gap-6 md:grid-cols-3">
                    <!-- Информация о клиенте -->
                    <div class="md:col-span-1">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex items-center mb-4">
                                <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-blue-500 text-2xl font-bold" id="client-avatar">
                                    JD
                                </div>
                                <div class="ml-4">
                                    <h4 class="font-semibold text-lg" id="view-client-fullname">John Doe</h4>
                                    <div class="text-gray-500 text-sm" id="view-client-company">Acme Inc.</div>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <div>
                                    <div class="text-xs text-gray-500">Телефон</div>
                                    <div class="font-medium" id="view-client-phone">+7 (123) 456-78-90</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">Email</div>
                                    <div class="font-medium" id="view-client-email">john@example.com</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">Источник</div>
                                    <div class="font-medium capitalize" id="view-client-source">website</div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">Статус</div>
                                    <div class="font-medium">
                                        <span id="view-client-status" class="px-2 py-1 rounded-full text-xs"></span>
                                    </div>
                                </div>
                                <div>
                                    <div class="text-xs text-gray-500">Добавлен</div>
                                    <div class="font-medium" id="view-client-created">01.01.2023</div>
                                </div>
                            </div>
                            
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <button id="edit-client-btn" class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center justify-center">
                                    <i class="fas fa-edit mr-2"></i> Редактировать
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- История взаимодействий -->
                    <div class="md:col-span-2">
                        <div class="mb-6">
                            <h4 class="font-semibold text-lg mb-4">Заметки</h4>
                            <div class="bg-gray-50 p-4 rounded-lg" id="view-client-notes">
                                Нет заметок
                            </div>
                        </div>
                        
                        <div>
                            <h4 class="font-semibold text-lg mb-4">История взаимодействий</h4>
                            <div class="space-y-4" id="client-history">
                                <div class="relative timeline-item pl-10">
                                    <div class="absolute left-0 top-0 w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-500">
                                        <i class="fas fa-user-plus"></i>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <div class="font-medium">Клиент добавлен в систему</div>
                                                <div class="text-sm text-gray-500">01.01.2023 12:00</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Форма добавления взаимодействия -->
                            <div class="mt-6">
                                <form id="interaction-form">
                                    <input type="hidden" id="interaction-client-id">
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-2">Тип взаимодействия</label>
                                        <select id="interaction-type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <option value="call">Звонок</option>
                                            <option value="meeting">Встреча</option>
                                            <option value="email">Email</option>
                                            <option value="message">Сообщение</option>
                                            <option value="other">Другое</option>
                                        </select>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-gray-700 mb-2">Комментарий</label>
                                        <textarea id="interaction-comment" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Опишите суть взаимодействия" required></textarea>
                                    </div>
                                    <div class="flex justify-end">
                                        <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 flex items-center">
                                            <i class="fas fa-plus mr-2"></i> Добавить
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Состояние приложения
        const crmState = {
            clients: [],
            currentPage: 1,
            itemsPerPage: 10,
            statusFilter: 'all',
            sourceFilter: 'all',
            dateFrom: '',
            searchQuery: '',
            editClientId: null,
            viewClientId: null
        };
        
        // Элементы DOM
        const crmElements = {
            newClientBtn: document.getElementById('new-client-btn'),
            clientModal: document.getElementById('client-modal'),
            viewClientModal: document.getElementById('view-client-modal'),
            closeClientModal: document.getElementById('close-client-modal'),
            closeViewClientModal: document.getElementById('close-view-client-modal'),
            cancelClient: document.getElementById('cancel-client'),
            clientForm: document.getElementById('client-form'),
            clientId: document.getElementById('client-id'),
            clientName: document.getElementById('client-name'),
            clientCompany: document.getElementById('client-company'),
            clientPhone: document.getElementById('client-phone'),
            clientEmail: document.getElementById('client-email'),
            clientSource: document.getElementById('client-source'),
            clientStatus: document.getElementById('client-status'),
            clientNotes: document.getElementById('client-notes'),
            modalTitle: document.getElementById('modal-title'),
            statusFilter: document.getElementById('status-filter'),
            sourceFilter: document.getElementById('source-filter'),
            dateFrom: document.getElementById('date-from'),
            search: document.getElementById('search'),
            clientsList: document.getElementById('clients-list'),
            clientsCount: document.getElementById('clients-count'),
            prevPage: document.getElementById('prev-page'),
            nextPage: document.getElementById('next-page'),
            pageInfo: document.getElementById('page-info'),
            totalClients: document.getElementById('total-clients'),
            newClients: document.getElementById('new-clients'),
            activeClients: document.getElementById('active-clients'),
            proposalClients: document.getElementById('proposal-clients'),
            closedClients: document.getElementById('closed-clients'),
            viewClientName: document.getElementById('view-client-name'),
            viewClientFullname: document.getElementById('view-client-fullname'),
            viewClientCompany: document.getElementById('view-client-company'),
            viewClientPhone: document.getElementById('view-client-phone'),
            viewClientEmail: document.getElementById('view-client-email'),
            viewClientSource: document.getElementById('view-client-source'),
            viewClientStatus: document.getElementById('view-client-status'),
            viewClientCreated: document.getElementById('view-client-created'),
            viewClientNotes: document.getElementById('view-client-notes'),
            clientAvatar: document.getElementById('client-avatar'),
            clientHistory: document.getElementById('client-history'),
            editClientBtn: document.getElementById('edit-client-btn'),
            interactionForm: document.getElementById('interaction-form'),
            interactionClientId: document.getElementById('interaction-client-id'),
            interactionType: document.getElementById('interaction-type'),
            interactionComment: document.getElementById('interaction-comment')
        };
        
        // Инициализация приложения
        function initCRM() {
            // Загружаем данные из localStorage
            loadClientsFromStorage();
            
            // Настройка обработчиков событий
            setupCRMEventListeners();
            
            // Инициализация пагинации
            updatePagination();
            
            // Обновляем статистику
            updateStatistics();
        }
        
        // Загрузка данных из localStorage
        function loadClientsFromStorage() {
            const savedClients = localStorage.getItem('crm-clients');
            if (savedClients) {
                crmState.clients = JSON.parse(savedClients);
                renderClients();
            }
        }
        
        // Сохранение данных в localStorage
        function saveClientsToStorage() {
            localStorage.setItem('crm-clients', JSON.stringify(crmState.clients));
        }
        
        // Настройка обработчиков событий
        function setupCRMEventListeners() {
            // Открытие модального окна добавления клиента
            crmElements.newClientBtn.addEventListener('click', function() {
                openClientModal();
            });
            
            // Закрытие модального окна
            crmElements.closeClientModal.addEventListener('click', function() {
                crmElements.clientModal.classList.add('hidden');
            });
            
            crmElements.cancelClient.addEventListener('click', function() {
                crmElements.clientModal.classList.add('hidden');
            });
            
            // Закрытие модального окна просмотра
            crmElements.closeViewClientModal.addEventListener('click', function() {
                crmElements.viewClientModal.classList.add('hidden');
            });
            
            // Обработка отправки формы клиента
            crmElements.clientForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const clientData = {
                    id: crmElements.clientId.value ? parseInt(crmElements.clientId.value) : Date.now(),
                    name: crmElements.clientName.value.trim(),
                    company: crmElements.clientCompany.value.trim(),
                    phone: crmElements.clientPhone.value.trim(),
                    email: crmElements.clientEmail.value.trim(),
                    source: crmElements.clientSource.value,
                    status: crmElements.clientStatus.value,
                    notes: crmElements.clientNotes.value.trim(),
                    createdAt: crmElements.clientId.value ? 
                        crmState.clients.find(c => c.id === parseInt(crmElements.clientId.value)).createdAt : 
                        new Date().toISOString(),
                    interactions: crmElements.clientId.value ? 
                        crmState.clients.find(c => c.id === parseInt(crmElements.clientId.value)).interactions : 
                        [{
                            type: 'created',
                            comment: 'Клиент добавлен в систему',
                            date: new Date().toISOString()
                        }]
                };
                
                if (crmElements.clientId.value) {
                    // Редактирование существующего клиента
                    const index = crmState.clients.findIndex(c => c.id === parseInt(crmElements.clientId.value));
                    crmState.clients[index] = clientData;
                    
                    // Добавляем запись о редактировании
                    clientData.interactions.push({
                        type: 'updated',
                        comment: 'Данные клиента обновлены',
                        date: new Date().toISOString()
                    });
                    
                    showNotification('Клиент успешно обновлён', 'success');
                } else {
                    // Добавление нового клиента
                    crmState.clients.unshift(clientData);
                    showNotification('Клиент успешно добавлен', 'success');
                }
                
                // Сохраняем и обновляем интерфейс
                saveClientsToStorage();
                renderClients();
                updateStatistics();
                updatePagination();
                
                // Закрываем модальное окно
                crmElements.clientModal.classList.add('hidden');
                
                // Сбрасываем форму
                this.reset();
            });
            
            // Фильтрация клиентов
            crmElements.statusFilter.addEventListener('change', function() {
                crmState.statusFilter = this.value;
                crmState.currentPage = 1;
                renderClients();
                updatePagination();
            });
            
            crmElements.sourceFilter.addEventListener('change', function() {
                crmState.sourceFilter = this.value;
                crmState.currentPage = 1;
                renderClients();
                updatePagination();
            });
            
            crmElements.dateFrom.addEventListener('change', function() {
                crmState.dateFrom = this.value;
                crmState.currentPage = 1;
                renderClients();
                updatePagination();
            });
            
            crmElements.search.addEventListener('input', function() {
                crmState.searchQuery = this.value.toLowerCase();
                crmState.currentPage = 1;
                renderClients();
                updatePagination();
            });
            
            // Пагинация
            crmElements.prevPage.addEventListener('click', function() {
                if (crmState.currentPage > 1) {
                    crmState.currentPage--;
                    renderClients();
                    updatePagination();
                }
            });
            
            crmElements.nextPage.addEventListener('click', function() {
                const filteredClients = getFilteredClients();
                const totalPages = Math.ceil(filteredClients.length / crmState.itemsPerPage);
                
                if (crmState.currentPage < totalPages) {
                    crmState.currentPage++;
                    renderClients();
                    updatePagination();
                }
            });
            
            // Редактирование клиента из окна просмотра
            crmElements.editClientBtn.addEventListener('click', function() {
                crmElements.viewClientModal.classList.add('hidden');
                openClientModal(crmState.viewClientId);
            });
            
            // Добавление взаимодействия
            crmElements.interactionForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const clientId = parseInt(crmElements.interactionClientId.value);
                const clientIndex = crmState.clients.findIndex(c => c.id === clientId);
                
                if (clientIndex !== -1) {
                    const interaction = {
                        type: crmElements.interactionType.value,
                        comment: crmElements.interactionComment.value.trim(),
                        date: new Date().toISOString()
                    };
                    
                    crmState.clients[clientIndex].interactions.push(interaction);
                    saveClientsToStorage();
                    
                    // Обновляем историю
                    renderClientHistory(clientId);
                    
                    // Сбрасываем форму
                    crmElements.interactionComment.value = '';
                    
                    showNotification('Взаимодействие добавлено', 'success');
                }
            });
        }
        
        // Открытие модального окна клиента
        function openClientModal(clientId = null) {
            if (clientId) {
                // Редактирование существующего клиента
                const client = crmState.clients.find(c => c.id === clientId);
                if (client) {
                    crmElements.modalTitle.textContent = 'Редактирование клиента';
                    crmElements.clientId.value = client.id;
                    crmElements.clientName.value = client.name;
                    crmElements.clientCompany.value = client.company || '';
                    crmElements.clientPhone.value = client.phone;
                    crmElements.clientEmail.value = client.email || '';
                    crmElements.clientSource.value = client.source;
                    crmElements.clientStatus.value = client.status;
                    crmElements.clientNotes.value = client.notes || '';
                }
            } else {
                // Добавление нового клиента
                crmElements.modalTitle.textContent = 'Новый клиент';
                crmElements.clientId.value = '';
                crmElements.clientForm.reset();
                crmElements.clientStatus.value = 'new';
            }
            
            crmElements.clientModal.classList.remove('hidden');
        }
        
        // Открытие модального окна просмотра клиента
        function openViewClientModal(clientId) {
            const client = crmState.clients.find(c => c.id === clientId);
            if (!client) return;
            
            crmState.viewClientId = clientId;
            
            // Заполняем данные клиента
            const createdAt = new Date(client.createdAt);
            const formattedDate = createdAt.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'numeric',
                year: 'numeric'
            });
            
            // Генерируем аватар из инициалов
            const initials = client.name.split(' ').map(n => n[0]).join('').toUpperCase();
            
            crmElements.viewClientName.textContent = client.name;
            crmElements.viewClientFullname.textContent = client.name;
            crmElements.viewClientCompany.textContent = client.company || 'Не указано';
            crmElements.viewClientPhone.textContent = client.phone;
            crmElements.viewClientEmail.textContent = client.email || 'Не указан';
            crmElements.viewClientSource.textContent = getSourceName(client.source);
            crmElements.viewClientCreated.textContent = formattedDate;
            crmElements.viewClientNotes.textContent = client.notes || 'Нет заметок';
            crmElements.clientAvatar.textContent = initials;
            crmElements.interactionClientId.value = clientId;
            
            // Устанавливаем статус
            const statusElement = crmElements.viewClientStatus;
            statusElement.textContent = getStatusName(client.status);
            statusElement.className = 'px-2 py-1 rounded-full text-xs ' + getStatusClass(client.status);
            
            // Заполняем историю взаимодействий
            renderClientHistory(clientId);
            
            // Открываем модальное окно
            crmElements.viewClientModal.classList.remove('hidden');
        }
        
        // Рендер истории взаимодействий
        function renderClientHistory(clientId) {
            const client = crmState.clients.find(c => c.id === clientId);
            if (!client) return;
            
            crmElements.clientHistory.innerHTML = '';
            
            // Сортируем взаимодействия по дате (новые сверху)
            const sortedInteractions = [...client.interactions].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedInteractions.forEach(interaction => {
                const date = new Date(interaction.date);
                const formattedDate = date.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                let icon, iconClass, title;
                
                switch(interaction.type) {
                    case 'created':
                        icon = 'fa-user-plus';
                        iconClass = 'bg-blue-100 text-blue-500';
                        title = 'Клиент добавлен в систему';
                        break;
                    case 'updated':
                        icon = 'fa-edit';
                        iconClass = 'bg-yellow-100 text-yellow-500';
                        title = 'Данные клиента обновлены';
                        break;
                    case 'call':
                        icon = 'fa-phone';
                        iconClass = 'bg-green-100 text-green-500';
                        title = 'Звонок';
                        break;
                    case 'meeting':
                        icon = 'fa-handshake';
                        iconClass = 'bg-purple-100 text-purple-500';
                        title = 'Встреча';
                        break;
                    case 'email':
                        icon = 'fa-envelope';
                        iconClass = 'bg-red-100 text-red-500';
                        title = 'Email';
                        break;
                    case 'message':
                        icon = 'fa-comment';
                        iconClass = 'bg-indigo-100 text-indigo-500';
                        title = 'Сообщение';
                        break;
                    default:
                        icon = 'fa-circle';
                        iconClass = 'bg-gray-100 text-gray-500';
                        title = 'Взаимодействие';
                }
                
                const interactionElement = document.createElement('div');
                interactionElement.className = 'relative timeline-item pl-10';
                interactionElement.innerHTML = `
                    <div class="absolute left-0 top-0 w-8 h-8 rounded-full ${iconClass} flex items-center justify-center">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-medium">${title}</div>
                                <div class="text-sm text-gray-500">${formattedDate}</div>
                                ${interaction.comment ? `<div class="mt-2 text-sm">${interaction.comment}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                crmElements.clientHistory.appendChild(interactionElement);
            });
        }
        
        // Получение отфильтрованных клиентов
        function getFilteredClients() {
            let filteredClients = [...crmState.clients];
            
            // Фильтрация по статусу
            if (crmState.statusFilter !== 'all') {
                filteredClients = filteredClients.filter(c => c.status === crmState.statusFilter);
            }
            
            // Фильтрация по источнику
            if (crmState.sourceFilter !== 'all') {
                filteredClients = filteredClients.filter(c => c.source === crmState.sourceFilter);
            }
            
            // Фильтрация по дате
            if (crmState.dateFrom) {
                filteredClients = filteredClients.filter(c => {
                    const clientDate = new Date(c.createdAt).toISOString().split('T')[0];
                    return clientDate >= crmState.dateFrom;
                });
            }
            
            // Поиск
            if (crmState.searchQuery) {
                filteredClients = filteredClients.filter(c => {
                    return c.name.toLowerCase().includes(crmState.searchQuery) ||
                           (c.company && c.company.toLowerCase().includes(crmState.searchQuery)) ||
                           c.phone.toLowerCase().includes(crmState.searchQuery) ||
                           (c.email && c.email.toLowerCase().includes(crmState.searchQuery));
                });
            }
            
            return filteredClients;
        }
        
        // Рендер списка клиентов
        function renderClients() {
            const filteredClients = getFilteredClients();
            
            // Пагинация
            const startIndex = (crmState.currentPage - 1) * crmState.itemsPerPage;
            const endIndex = startIndex + crmState.itemsPerPage;
            const paginatedClients = filteredClients.slice(startIndex, endIndex);
            
            crmElements.clientsList.innerHTML = '';
            
            if (paginatedClients.length === 0) {
                crmElements.clientsList.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            <i class="fas fa-inbox text-3xl mb-2"></i>
                            <p>Нет клиентов</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            paginatedClients.forEach(client => {
                const createdAt = new Date(client.createdAt);
                const formattedDate = createdAt.toLocaleDateString('ru-RU', {
                    day: 'numeric',
                    month: 'numeric',
                    year: 'numeric'
                });
                
                const clientElement = document.createElement('tr');
                clientElement.className = 'hover:bg-gray-50';
                clientElement.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-500 font-bold">
                                ${client.name.split(' ').map(n => n[0]).join('').toUpperCase()}
                            </div>
                            <div class="ml-4">
                                <div class="font-medium text-gray-900">${client.name}</div>
                                <div class="text-gray-500 text-sm">${client.company || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-gray-900">${client.phone}</div>
                        <div class="text-gray-500 text-sm">${client.email || ''}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 py-1 ${getStatusClass(client.status)} rounded-full text-xs">
                            ${getStatusName(client.status)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap capitalize">
                        ${getSourceName(client.source)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-gray-900">${formattedDate}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button class="text-blue-500 hover:text-blue-700 mr-3 view-client-btn" data-id="${client.id}">
                            <i class="fas fa-eye mr-1"></i>
                        </button>
                        <button class="text-gray-500 hover:text-gray-700 edit-client-btn" data-id="${client.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                
                crmElements.clientsList.appendChild(clientElement);
            });
            
            // Обновляем счетчик клиентов
            crmElements.clientsCount.textContent = `Показано ${paginatedClients.length} из ${filteredClients.length}`;
            
            // Добавляем обработчики для кнопок просмотра
            document.querySelectorAll('.view-client-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const clientId = parseInt(this.dataset.id);
                    openViewClientModal(clientId);
                });
            });
            
            // Добавляем обработчики для кнопок редактирования
            document.querySelectorAll('.edit-client-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const clientId = parseInt(this.dataset.id);
                    openClientModal(clientId);
                });
            });
        }
        
        // Обновление пагинации
        function updatePagination() {
            const filteredClients = getFilteredClients();
            const totalPages = Math.ceil(filteredClients.length / crmState.itemsPerPage);
            
            // Обновляем информацию о странице
            crmElements.pageInfo.textContent = `Страница ${crmState.currentPage} из ${totalPages || 1}`;
            
            // Обновляем состояние кнопок
            crmElements.prevPage.disabled = crmState.currentPage <= 1;
            crmElements.nextPage.disabled = crmState.currentPage >= totalPages;
        }
        
        // Обновление статистики
        function updateStatistics() {
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            // Общее количество клиентов
            crmElements.totalClients.textContent = crmState.clients.length;
            
            // Клиенты по статусам
            crmElements.newClients.textContent = crmState.clients.filter(c => c.status === 'new').length;
            crmElements.activeClients.textContent = crmState.clients.filter(c => c.status === 'contacted' || c.status === 'negotiation').length;
            crmElements.proposalClients.textContent = crmState.clients.filter(c => c.status === 'proposal').length;
            crmElements.closedClients.textContent = crmState.clients.filter(c => c.status === 'closed').length;
        }
        
        // Получение класса для статуса
        function getStatusClass(status) {
            switch(status) {
                case 'new': return 'bg-gray-100 text-gray-800';
                case 'contacted': return 'bg-blue-100 text-blue-800';
                case 'proposal': return 'bg-yellow-100 text-yellow-800';
                case 'negotiation': return 'bg-purple-100 text-purple-800';
                case 'closed': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }
        
        // Получение названия статуса
        function getStatusName(status) {
            switch(status) {
                case 'new': return 'Новый';
                case 'contacted': return 'Контакт';
                case 'proposal': return 'Предложение';
                case 'negotiation': return 'Переговоры';
                case 'closed': return 'Закрыт';
                default: return status;
            }
        }
        
        // Получение названия источника
        function getSourceName(source) {
            switch(source) {
                case 'website': return 'Сайт';
                case 'social': return 'Соцсети';
                case 'recommendation': return 'Рекомендация';
                case 'ad': return 'Реклама';
                case 'other': return 'Другое';
                default: return source;
            }
        }
        
        // Показать уведомление
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg text-white ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } animate-bounce`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-2"></i>
                ${message}
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('animate-bounce');
                notification.classList.add('opacity-0', 'transition-opacity', 'duration-500');
                setTimeout(() => notification.remove(), 500);
            }, 3000);
        }
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', initCRM);
    </script>
</body>
</html>
