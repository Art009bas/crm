<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM System | Стартап</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        
        .status-lead {
            background-color: #e0f2fe;
            color: #0369a1;
        }
        
        .status-prospect {
            background-color: #f0f9ff;
            color: #0ea5e9;
        }
        
        .status-trial {
            background-color: #ecfccb;
            color: #65a30d;
        }
        
        .status-customer {
            background-color: #dcfce7;
            color: #16a34a;
        }
        
        .status-churned {
            background-color: #fee2e2;
            color: #dc2626;
        }
        
        .funnel-stage {
            position: relative;
        }
        
        .funnel-stage:after {
            content: "";
            position: absolute;
            right: -10px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-left: 10px solid #e5e7eb;
        }
        
        .funnel-stage:last-child:after {
            display: none;
        }
        
        .progress-bar {
            height: 6px;
            border-radius: 3px;
            background-color: #e5e7eb;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 3px;
            background-color: #3b82f6;
            transition: width 0.5s ease;
        }
        
        .customer-card {
            transition: all 0.2s;
        }
        
        .customer-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        @media (max-width: 640px) {
            .funnel-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 20px;
            }
            
            .funnel-stages {
                min-width: 500px;
            }
            
            .customer-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Анимация для уведомлений */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideIn 0.3s ease-out forwards;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification.hide {
            animation: slideOut 0.3s ease-out forwards;
        }
        
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Уведомления -->
    <div id="notification-area"></div>
    
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Шапка CRM -->
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-users text-blue-500 mr-3"></i>
                    CRM System
                </h1>
                <p class="text-gray-500 mt-1">Управление клиентами и воронкой продаж</p>
            </div>
            
            <div class="flex items-center space-x-4 w-full md:w-auto">
                <button id="add-customer" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 w-full md:w-auto">
                    <i class="fas fa-plus mr-2"></i> Новый клиент
                </button>
                <button id="export-data" class="px-4 py-2 border border-blue-500 text-blue-500 rounded-lg hover:bg-blue-50 w-full md:w-auto">
                    <i class="fas fa-file-export mr-2"></i> Экспорт
                </button>
            </div>
        </div>
        
        <!-- Статистика -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm p-4">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm">Всего клиентов</p>
                        <h3 class="text-2xl font-bold mt-1" id="total-customers">0</h3>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg text-blue-500">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div class="mt-2 text-sm text-green-500" id="total-growth">
                    <i class="fas fa-arrow-up mr-1"></i> 0% за месяц
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-4">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm">Новые лиды</p>
                        <h3 class="text-2xl font-bold mt-1" id="new-leads">0</h3>
                    </div>
                    <div class="bg-green-100 p-3 rounded-lg text-green-500">
                        <i class="fas fa-bullseye"></i>
                    </div>
                </div>
                <div class="mt-2 text-sm text-green-500" id="leads-growth">
                    <i class="fas fa-arrow-up mr-1"></i> 0% за неделю
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-4">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm">Конверсия</p>
                        <h3 class="text-2xl font-bold mt-1" id="conversion-rate">0%</h3>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-lg text-purple-500">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <div class="mt-2 text-sm" id="conversion-change">
                    <i class="fas fa-arrow-up mr-1"></i> 0% за месяц
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-sm p-4">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-gray-500 text-sm">Доход</p>
                        <h3 class="text-2xl font-bold mt-1" id="total-revenue">$0</h3>
                    </div>
                    <div class="bg-yellow-100 p-3 rounded-lg text-yellow-500">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                </div>
                <div class="mt-2 text-sm text-green-500" id="revenue-growth">
                    <i class="fas fa-arrow-up mr-1"></i> 0% за месяц
                </div>
            </div>
        </div>
        
        <!-- Воронка продаж -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-700">
                    <i class="fas fa-filter text-blue-500 mr-2"></i>
                    Воронка привлечения клиентов
                </h2>
                <select id="funnel-period" class="px-3 py-1 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="week">За неделю</option>
                    <option value="month" selected>За месяц</option>
                    <option value="quarter">За квартал</option>
                    <option value="year">За год</option>
                </select>
            </div>
            
            <div class="funnel-container">
                <div class="funnel-stages flex justify-between items-center bg-gray-50 rounded-lg p-4" id="funnel-stages">
                    <!-- Динамически заполняется JS -->
                </div>
            </div>
            
            <div class="mt-4">
                <div class="flex justify-between text-sm text-gray-500 mb-1">
                    <span>Прогресс по воронке</span>
                    <span id="funnel-progress-text">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="funnel-progress-bar" style="width: 0%"></div>
                </div>
            </div>
        </div>
        
        <!-- Фильтры и поиск -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <input type="text" id="search-customers" placeholder="Поиск клиентов..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex space-x-2">
                    <select id="filter-status" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Все статусы</option>
                        <option value="lead">Лид</option>
                        <option value="prospect">Потенциальный</option>
                        <option value="trial">Пробный период</option>
                        <option value="customer">Клиент</option>
                        <option value="churned">Ушедший</option>
                    </select>
                    
                    <select id="sort-customers" class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="newest">Сначала новые</option>
                        <option value="oldest">Сначала старые</option>
                        <option value="name">По имени</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Список клиентов -->
        <div class="mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-700">
                    <i class="fas fa-list-ul text-blue-500 mr-2"></i>
                    Клиенты
                </h2>
                <div class="text-sm text-gray-500" id="showing-customers">Показано 0 из 0</div>
            </div>
            
            <div class="customer-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="customers-container">
                <!-- Динамически заполняется JS -->
            </div>
            
            <div class="mt-6 flex justify-center">
                <button id="load-more" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 hidden">
                    Показать еще
                </button>
            </div>
        </div>
        
        <!-- Модальное окно клиента -->
        <div id="customer-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-semibold text-gray-800" id="customer-modal-title">Новый клиент</h3>
                    <button id="close-customer-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">ФИО *</label>
                    <input type="text" id="customer-name" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">Компания</label>
                    <input type="text" id="customer-company" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-700 mb-2">Email *</label>
                        <input type="email" id="customer-email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 mb-2">Телефон *</label>
                        <input type="tel" id="customer-phone" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-gray-700 mb-2">Статус *</label>
                        <select id="customer-status" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="lead">Лид</option>
                            <option value="prospect">Потенциальный</option>
                            <option value="trial">Пробный период</option>
                            <option value="customer">Клиент</option>
                            <option value="churned">Ушедший</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 mb-2">Источник</label>
                        <select id="customer-source" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="website">Сайт</option>
                            <option value="social">Соцсети</option>
                            <option value="recommendation">Рекомендация</option>
                            <option value="event">Мероприятие</option>
                            <option value="other">Другое</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-6">
                    <label class="block text-gray-700 mb-2">Заметки</label>
                    <textarea id="customer-notes" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 min-h-[100px]"></textarea>
                </div>
                
                <div class="flex justify-between items-center">
                    <button id="delete-customer" class="px-4 py-2 text-red-500 hover:text-red-700 hidden">
                        <i class="fas fa-trash mr-2"></i> Удалить
                    </button>
                    
                    <div class="flex space-x-3">
                        <button id="cancel-customer" class="px-4 py-2 text-gray-600 hover:text-gray-800">Отмена</button>
                        <button id="save-customer" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">Сохранить</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Модальное окно подтверждения удаления -->
        <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Подтверждение удаления</h3>
                    <button id="close-confirm-modal" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <p class="mb-6">Вы уверены, что хотите удалить этого клиента? Это действие нельзя отменить.</p>
                
                <div class="flex justify-end space-x-3">
                    <button id="cancel-delete" class="px-4 py-2 text-gray-600 hover:text-gray-800">Отмена</button>
                    <button id="confirm-delete" class="px-6 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">Удалить</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Состояние CRM
        const crmState = {
            customers: [],
            filteredCustomers: [],
            currentPage: 1,
            pageSize: 6,
            editingCustomer: null,
            searchQuery: '',
            statusFilter: '',
            sortOption: 'newest',
            funnelPeriod: 'month'
        };
        
        // Инициализация CRM
        function initCRM() {
            loadCustomers();
            setupEventListeners();
            renderStatistics();
            renderFunnel();
        }
        
        // Загрузка клиентов из localStorage
        function loadCustomers() {
            const savedCustomers = localStorage.getItem('crm-customers');
            if (savedCustomers) {
                crmState.customers = JSON.parse(savedCustomers);
                // Преобразование строк даты обратно в объекты Date
                crmState.customers.forEach(customer => {
                    customer.createdAt = new Date(customer.createdAt);
                });
            } else {
                // Загрузка демо-данных, если нет сохраненных
                loadDemoData();
            }
            filterAndSortCustomers();
        }
        
        // Загрузка демо-данных
        function loadDemoData() {
            const demoCustomers = [
                {
                    id: 1,
                    name: "Алексей Петров",
                    company: "ООО \"ТехноПром\"",
                    email: "alexey@techprom.ru",
                    phone: "+7 (912) 345-67-89",
                    status: "lead",
                    source: "website",
                    notes: "Интересуется интеграцией с 1С",
                    createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000)
                },
                {
                    id: 2,
                    name: "Елена Смирнова",
                    company: "ИП Смирнова",
                    email: "elena@smirnova.ru",
                    phone: "+7 (987) 654-32-10",
                    status: "prospect",
                    source: "social",
                    notes: "Требуется демонстрация продукта",
                    createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
                },
                {
                    id: 3,
                    name: "Дмитрий Иванов",
                    company: "ООО \"Вектор\"",
                    email: "dmitry@vector.ru",
                    phone: "+7 (905) 123-45-67",
                    status: "trial",
                    source: "recommendation",
                    notes: "На пробном периоде до 15.07",
                    createdAt: new Date(Date.now() - 21 * 24 * 60 * 60 * 1000)
                },
                {
                    id: 4,
                    name: "Ольга Кузнецова",
                    company: "ООО \"СтарТех\"",
                    email: "olga@startech.ru",
                    phone: "+7 (916) 987-65-43",
                    status: "customer",
                    source: "event",
                    notes: "Оплатил годовую подписку",
                    createdAt: new Date(Date.now() - 60 * 24 * 60 * 60 * 1000)
                },
                {
                    id: 5,
                    name: "Андрей Соколов",
                    company: "ИП Соколов",
                    email: "andrey@sokolov.ru",
                    phone: "+7 (903) 456-78-90",
                    status: "churned",
                    source: "website",
                    notes: "Не устроила цена, ушел к конкурентам",
                    createdAt: new Date(Date.now() - 150 * 24 * 60 * 60 * 1000)
                },
                {
                    id: 6,
                    name: "Мария Васнецова",
                    company: "ООО \"ТехноЛаб\"",
                    email: "maria@technolab.ru",
                    phone: "+7 (925) 678-90-12",
                    status: "customer",
                    source: "other",
                    notes: "Корпоративный клиент, возможен опт",
                    createdAt: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)
                }
            ];
            
            crmState.customers = demoCustomers;
            saveCustomers();
        }
        
        // Сохранение клиентов в localStorage
        function saveCustomers() {
            localStorage.setItem('crm-customers', JSON.stringify(crmState.customers));
        }
        
        // Фильтрация и сортировка клиентов
        function filterAndSortCustomers() {
            let filtered = [...crmState.customers];
            
            // Применение поиска
            if (crmState.searchQuery) {
                const query = crmState.searchQuery.toLowerCase();
                filtered = filtered.filter(customer => 
                    customer.name.toLowerCase().includes(query) ||
                    customer.company.toLowerCase().includes(query) ||
                    customer.email.toLowerCase().includes(query) ||
                    customer.phone.toLowerCase().includes(query)
                );
            }
            
            // Применение фильтра по статусу
            if (crmState.statusFilter) {
                filtered = filtered.filter(customer => customer.status === crmState.statusFilter);
            }
            
            // Применение сортировки
            switch (crmState.sortOption) {
                case 'newest':
                    filtered.sort((a, b) => b.createdAt - a.createdAt);
                    break;
                case 'oldest':
                    filtered.sort((a, b) => a.createdAt - b.createdAt);
                    break;
                case 'name':
                    filtered.sort((a, b) => a.name.localeCompare(b.name));
                    break;
            }
            
            crmState.filteredCustomers = filtered;
            crmState.currentPage = 1;
            
            renderCustomers();
            updatePagination();
        }
        
        // Рендер списка клиентов
        function renderCustomers() {
            const container = document.getElementById('customers-container');
            container.innerHTML = '';
            
            const startIndex = (crmState.currentPage - 1) * crmState.pageSize;
            const endIndex = startIndex + crmState.pageSize;
            const customersToShow = crmState.filteredCustomers.slice(startIndex, endIndex);
            
            if (customersToShow.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-10">
                        <i class="fas fa-user-slash text-gray-300 text-4xl mb-3"></i>
                        <p class="text-gray-500">Клиенты не найдены</p>
                    </div>
                `;
                return;
            }
            
            customersToShow.forEach(customer => {
                const card = document.createElement('div');
                card.className = 'customer-card bg-white rounded-xl shadow-sm p-4 fade-in';
                
                // Определение класса статуса
                let statusClass = '';
                let statusText = '';
                
                switch (customer.status) {
                    case 'lead':
                        statusClass = 'status-lead';
                        statusText = 'Лид';
                        break;
                    case 'prospect':
                        statusClass = 'status-prospect';
                        statusText = 'Потенциальный';
                        break;
                    case 'trial':
                        statusClass = 'status-trial';
                        statusText = 'Пробный период';
                        break;
                    case 'customer':
                        statusClass = 'status-customer';
                        statusText = 'Клиент';
                        break;
                    case 'churned':
                        statusClass = 'status-churned';
                        statusText = 'Ушедший';
                        break;
                }
                
                // Форматирование даты
                const formattedDate = formatDate(customer.createdAt);
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <h3 class="font-bold text-lg">${customer.name}</h3>
                            <p class="text-gray-500 text-sm">${customer.company || 'Не указано'}</p>
                        </div>
                        <span class="${statusClass} text-xs font-medium px-2 py-1 rounded-full">${statusText}</span>
                    </div>
                    
                    <div class="flex items-center text-gray-500 text-sm mb-3">
                        <i class="fas fa-envelope mr-2"></i>
                        <span>${customer.email}</span>
                    </div>
                    
                    <div class="flex items-center text-gray-500 text-sm mb-4">
                        <i class="fas fa-phone mr-2"></i>
                        <span>${customer.phone}</span>
                    </div>
                    
                    <div class="flex justify-between items-center">
                        <div class="text-xs text-gray-400">Добавлен ${formattedDate}</div>
                        <div class="flex space-x-2">
                            <button class="edit-btn p-1 text-blue-500 hover:text-blue-700" data-id="${customer.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-btn p-1 text-red-500 hover:text-red-700" data-id="${customer.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            // Добавление обработчиков событий для кнопок редактирования и удаления
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const customerId = parseInt(e.currentTarget.getAttribute('data-id'));
                    const customer = crmState.customers.find(c => c.id === customerId);
                    if (customer) {
                        openCustomerModal(customer);
                    }
                });
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const customerId = parseInt(e.currentTarget.getAttribute('data-id'));
                    const customer = crmState.customers.find(c => c.id === customerId);
                    if (customer) {
                        openConfirmModal(customer);
                    }
                });
            });
            
            // Обновление текста "Показано X из Y"
            updateShowingText();
        }
        
        // Обновление текста "Показано X из Y"
        function updateShowingText() {
            const startIndex = (crmState.currentPage - 1) * crmState.pageSize + 1;
            const endIndex = Math.min(startIndex + crmState.pageSize - 1, crmState.filteredCustomers.length);
            const total = crmState.filteredCustomers.length;
            
            document.getElementById('showing-customers').textContent = 
                `Показано ${startIndex}-${endIndex} из ${total}`;
        }
        
        // Обновление пагинации
        function updatePagination() {
            const loadMoreBtn = document.getElementById('load-more');
            const hasMore = crmState.filteredCustomers.length > crmState.currentPage * crmState.pageSize;
            
            if (hasMore) {
                loadMoreBtn.classList.remove('hidden');
            } else {
                loadMoreBtn.classList.add('hidden');
            }
        }
        
        // Форматирование даты
        function formatDate(date) {
            const now = new Date();
            const diffInDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            
            if (diffInDays === 0) {
                return 'сегодня';
            } else if (diffInDays === 1) {
                return 'вчера';
            } else if (diffInDays < 7) {
                return `${diffInDays} дня назад`;
            } else if (diffInDays < 30) {
                const weeks = Math.floor(diffInDays / 7);
                return `${weeks} ${weeks === 1 ? 'неделю' : 'недели'} назад`;
            } else if (diffInDays < 365) {
                const months = Math.floor(diffInDays / 30);
                return `${months} ${months === 1 ? 'месяц' : months < 5 ? 'месяца' : 'месяцев'} назад`;
            } else {
                const years = Math.floor(diffInDays / 365);
                return `${years} ${years === 1 ? 'год' : years < 5 ? 'года' : 'лет'} назад`;
            }
        }
        
        // Открытие модального окна клиента
        function openCustomerModal(customer = null) {
            const modal = document.getElementById('customer-modal');
            const deleteBtn = document.getElementById('delete-customer');
            
            if (customer) {
                // Редактирование существующего клиента
                crmState.editingCustomer = customer;
                document.getElementById('customer-modal-title').textContent = 'Редактирование клиента';
                document.getElementById('customer-name').value = customer.name;
                document.getElementById('customer-company').value = customer.company || '';
                document.getElementById('customer-email').value = customer.email;
                document.getElementById('customer-phone').value = customer.phone;
                document.getElementById('customer-status').value = customer.status;
                document.getElementById('customer-source').value = customer.source || 'website';
                document.getElementById('customer-notes').value = customer.notes || '';
                
                // Показываем кнопку удаления
                deleteBtn.classList.remove('hidden');
                deleteBtn.setAttribute('data-id', customer.id);
            } else {
                // Создание нового клиента
                crmState.editingCustomer = null;
                document.getElementById('customer-modal-title').textContent = 'Новый клиент';
                document.getElementById('customer-name').value = '';
                document.getElementById('customer-company').value = '';
                document.getElementById('customer-email').value = '';
                document.getElementById('customer-phone').value = '';
                document.getElementById('customer-status').value = 'lead';
                document.getElementById('customer-source').value = 'website';
                document.getElementById('customer-notes').value = '';
                
                // Скрываем кнопку удаления
                deleteBtn.classList.add('hidden');
            }
            
            modal.classList.remove('hidden');
        }
        
        // Открытие модального окна подтверждения удаления
        function openConfirmModal(customer) {
            const modal = document.getElementById('confirm-modal');
            crmState.editingCustomer = customer;
            modal.classList.remove('hidden');
        }
        
        // Закрытие модального окна подтверждения удаления
        function closeConfirmModal() {
            const modal = document.getElementById('confirm-modal');
            modal.classList.add('hidden');
        }
        
        // Сохранение клиента
        function saveCustomer() {
            const name = document.getElementById('customer-name').value.trim();
            const email = document.getElementById('customer-email').value.trim();
            const phone = document.getElementById('customer-phone').value.trim();
            
            if (!name) {
                showNotification('Пожалуйста, укажите ФИО клиента', 'error');
                return;
            }
            
            if (!email) {
                showNotification('Пожалуйста, укажите email клиента', 'error');
                return;
            }
            
            if (!phone) {
                showNotification('Пожалуйста, укажите телефон клиента', 'error');
                return;
            }
            
            const customer = {
                id: crmState.editingCustomer ? crmState.editingCustomer.id : Date.now(),
                name: name,
                company: document.getElementById('customer-company').value.trim(),
                email: email,
                phone: phone,
                status: document.getElementById('customer-status').value,
                source: document.getElementById('customer-source').value,
                notes: document.getElementById('customer-notes').value.trim(),
                createdAt: crmState.editingCustomer ? crmState.editingCustomer.createdAt : new Date()
            };
            
            if (crmState.editingCustomer) {
                // Обновляем существующего клиента
                const index = crmState.customers.findIndex(c => c.id === customer.id);
                if (index !== -1) {
                    crmState.customers[index] = customer;
                    showNotification('Клиент успешно обновлен', 'success');
                }
            } else {
                // Добавляем нового клиента
                crmState.customers.push(customer);
                showNotification('Клиент успешно добавлен', 'success');
            }
            
            saveCustomers();
            closeCustomerModal();
            filterAndSortCustomers();
            renderStatistics();
            renderFunnel();
        }
        
        // Удаление клиента
        function deleteCustomer() {
            if (crmState.editingCustomer) {
                const index = crmState.customers.findIndex(c => c.id === crmState.editingCustomer.id);
                if (index !== -1) {
                    crmState.customers.splice(index, 1);
                    showNotification('Клиент успешно удален', 'success');
                    saveCustomers();
                    closeConfirmModal();
                    filterAndSortCustomers();
                    renderStatistics();
                    renderFunnel();
                }
            }
        }
        
        // Закрытие модального окна клиента
        function closeCustomerModal() {
            document.getElementById('customer-modal').classList.add('hidden');
            crmState.editingCustomer = null;
        }
        
        // Рендер статистики
        function renderStatistics() {
            const totalCustomers = crmState.customers.length;
            const newLeads = crmState.customers.filter(c => c.status === 'lead' && isRecent(c.createdAt, 7)).length;
            const customers = crmState.customers.filter(c => c.status === 'customer').length;
            const churned = crmState.customers.filter(c => c.status === 'churned').length;
            
            // Расчет конверсии (отношение клиентов к общему числу)
            const conversionRate = totalCustomers > 0 ? Math.round((customers / totalCustomers) * 100) : 0;
            
            // Расчет дохода (условный)
            const totalRevenue = customers * 99; // $99 за клиента
            
            // Расчет роста (условный)
            const prevMonthCustomers = crmState.customers.filter(c => c.createdAt < new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)).length;
            const currentMonthCustomers = totalCustomers - prevMonthCustomers;
            const totalGrowth = prevMonthCustomers > 0 ? Math.round((currentMonthCustomers / prevMonthCustomers) * 100) : currentMonthCustomers > 0 ? 100 : 0;
            
            const prevWeekLeads = crmState.customers.filter(c => c.status === 'lead' && c.createdAt < new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)).length;
            const currentWeekLeads = newLeads;
            const leadsGrowth = prevWeekLeads > 0 ? Math.round((currentWeekLeads / prevWeekLeads) * 100) : currentWeekLeads > 0 ? 100 : 0;
            
            const prevMonthRevenue = customers * 79; // $79 за клиента в прошлом месяце
            const revenueGrowth = prevMonthRevenue > 0 ? Math.round(((totalRevenue - prevMonthRevenue) / prevMonthRevenue) * 100) : totalRevenue > 0 ? 100 : 0;
            
            // Обновление DOM
            document.getElementById('total-customers').textContent = totalCustomers;
            document.getElementById('new-leads').textContent = newLeads;
            document.getElementById('conversion-rate').textContent = `${conversionRate}%`;
            document.getElementById('total-revenue').textContent = `$${totalRevenue.toLocaleString()}`;
            
            // Обновление роста
            const totalGrowthEl = document.getElementById('total-growth');
            totalGrowthEl.innerHTML = `<i class="fas fa-arrow-${totalGrowth >= 0 ? 'up' : 'down'} mr-1"></i> ${Math.abs(totalGrowth)}% за месяц`;
            totalGrowthEl.className = `mt-2 text-sm ${totalGrowth >= 0 ? 'text-green-500' : 'text-red-500'}`;
            
            const leadsGrowthEl = document.getElementById('leads-growth');
            leadsGrowthEl.innerHTML = `<i class="fas fa-arrow-${leadsGrowth >= 0 ? 'up' : 'down'} mr-1"></i> ${Math.abs(leadsGrowth)}% за неделю`;
            leadsGrowthEl.className = `mt-2 text-sm ${leadsGrowth >= 0 ? 'text-green-500' : 'text-red-500'}`;
            
            const conversionChangeEl = document.getElementById('conversion-change');
            const conversionChange = 5; // Условное изменение конверсии
            conversionChangeEl.innerHTML = `<i class="fas fa-arrow-${conversionChange >= 0 ? 'up' : 'down'} mr-1"></i> ${Math.abs(conversionChange)}% за месяц`;
            conversionChangeEl.className = `mt-2 text-sm ${conversionChange >= 0 ? 'text-green-500' : 'text-red-500'}`;
            
            const revenueGrowthEl = document.getElementById('revenue-growth');
            revenueGrowthEl.innerHTML = `<i class="fas fa-arrow-${revenueGrowth >= 0 ? 'up' : 'down'} mr-1"></i> ${Math.abs(revenueGrowth)}% за месяц`;
            revenueGrowthEl.className = `mt-2 text-sm ${revenueGrowth >= 0 ? 'text-green-500' : 'text-red-500'}`;
        }
        
        // Проверка, является ли дата недавней (за указанное количество дней)
        function isRecent(date, days) {
            const now = new Date();
            const diffInDays = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            return diffInDays <= days;
        }
        
        // Рендер воронки продаж
        function renderFunnel() {
            const funnelContainer = document.getElementById('funnel-stages');
            const period = crmState.funnelPeriod;
            
            // Расчет воронки для выбранного периода
            let awareness, leads, trials, customers, repeatCustomers;
            
            if (period === 'week') {
                awareness = crmState.customers.filter(c => isRecent(c.createdAt, 7)).length;
                leads = crmState.customers.filter(c => c.status === 'lead' && isRecent(c.createdAt, 7)).length;
                trials = crmState.customers.filter(c => c.status === 'trial' && isRecent(c.createdAt, 7)).length;
                customers = crmState.customers.filter(c => c.status === 'customer' && isRecent(c.createdAt, 7)).length;
                repeatCustomers = 0; // Упрощение для демо
            } else if (period === 'month') {
                awareness = crmState.customers.filter(c => isRecent(c.createdAt, 30)).length;
                leads = crmState.customers.filter(c => c.status === 'lead' && isRecent(c.createdAt, 30)).length;
                trials = crmState.customers.filter(c => c.status === 'trial' && isRecent(c.createdAt, 30)).length;
                customers = crmState.customers.filter(c => c.status === 'customer' && isRecent(c.createdAt, 30)).length;
                repeatCustomers = 0; // Упрощение для демо
            } else if (period === 'quarter') {
                awareness = crmState.customers.filter(c => isRecent(c.createdAt, 90)).length;
                leads = crmState.customers.filter(c => c.status === 'lead' && isRecent(c.createdAt, 90)).length;
                trials = crmState.customers.filter(c => c.status === 'trial' && isRecent(c.createdAt, 90)).length;
                customers = crmState.customers.filter(c => c.status === 'customer' && isRecent(c.createdAt, 90)).length;
                repeatCustomers = 0; // Упрощение для демо
            } else { // year
                awareness = crmState.customers.filter(c => isRecent(c.createdAt, 365)).length;
                leads = crmState.customers.filter(c => c.status === 'lead' && isRecent(c.createdAt, 365)).length;
                trials = crmState.customers.filter(c => c.status === 'trial' && isRecent(c.createdAt, 365)).length;
                customers = crmState.customers.filter(c => c.status === 'customer' && isRecent(c.createdAt, 365)).length;
                repeatCustomers = 0; // Упрощение для демо
            }
            
            // Расчет процентов для каждого этапа
            const awarenessPercent = 100;
            const leadsPercent = awareness > 0 ? Math.round((leads / awareness) * 100) : 0;
            const trialsPercent = awareness > 0 ? Math.round((trials / awareness) * 100) : 0;
            const customersPercent = awareness > 0 ? Math.round((customers / awareness) * 100) : 0;
            const repeatPercent = awareness > 0 ? Math.round((repeatCustomers / awareness) * 100) : 0;
            
            // Общий прогресс по воронке (усредненный)
            const funnelProgress = Math.round((leadsPercent + trialsPercent + customersPercent + repeatPercent) / 4);
            
            // Обновление DOM
            funnelContainer.innerHTML = `
                <div class="funnel-stage text-center px-4">
                    <div class="text-sm text-gray-500 mb-1">Знакомство</div>
                    <div class="text-xl font-bold">${awareness}</div>
                    <div class="text-xs text-gray-400 mt-1">${awarenessPercent}%</div>
                </div>
                
                <div class="funnel-stage text-center px-4">
                    <div class="text-sm text-gray-500 mb-1">Лид</div>
                    <div class="text-xl font-bold">${leads}</div>
                    <div class="text-xs text-gray-400 mt-1">${leadsPercent}%</div>
                </div>
                
                <div class="funnel-stage text-center px-4">
                    <div class="text-sm text-gray-500 mb-1">Пробный период</div>
                    <div class="text-xl font-bold">${trials}</div>
                    <div class="text-xs text-gray-400 mt-1">${trialsPercent}%</div>
                </div>
                
                <div class="funnel-stage text-center px-4">
                    <div class="text-sm text-gray-500 mb-1">Клиент</div>
                    <div class="text-xl font-bold">${customers}</div>
                    <div class="text-xs text-gray-400 mt-1">${customersPercent}%</div>
                </div>
                
                <div class="text-center px-4">
                    <div class="text-sm text-gray-500 mb-1">Повторные</div>
                    <div class="text-xl font-bold">${repeatCustomers}</div>
                    <div class="text-xs text-gray-400 mt-1">${repeatPercent}%</div>
                </div>
            `;
            
            // Обновление прогресс-бара
            document.getElementById('funnel-progress-text').textContent = `${funnelProgress}%`;
            document.getElementById('funnel-progress-bar').style.width = `${funnelProgress}%`;
        }
        
        // Показать уведомление
        function showNotification(message, type = 'info') {
            const notificationArea = document.getElementById('notification-area');
            const notification = document.createElement('div');
            
            let bgColor = 'bg-blue-500';
            if (type === 'success') bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'warning') bgColor = 'bg-yellow-500';
            
            notification.className = `notification ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            notificationArea.appendChild(notification);
            
            // Автоматическое скрытие через 3 секунды
            setTimeout(() => {
                notification.classList.add('hide');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
        
        // Экспорт данных
        function exportData() {
            const data = {
                customers: crmState.customers,
                timestamp: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `crm-export-${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('Данные успешно экспортированы', 'success');
        }
        
        // Настройка обработчиков событий
        function setupEventListeners() {
            // Кнопка добавления клиента
            document.getElementById('add-customer').addEventListener('click', () => openCustomerModal());
            
            // Кнопка экспорта данных
            document.getElementById('export-data').addEventListener('click', exportData);
            
            // Модальное окно клиента
            document.getElementById('close-customer-modal').addEventListener('click', closeCustomerModal);
            document.getElementById('cancel-customer').addEventListener('click', closeCustomerModal);
            document.getElementById('save-customer').addEventListener('click', saveCustomer);
            document.getElementById('delete-customer').addEventListener('click', () => {
                if (crmState.editingCustomer) {
                    openConfirmModal(crmState.editingCustomer);
                }
            });
            
            // Модальное окно подтверждения удаления
            document.getElementById('close-confirm-modal').addEventListener('click', closeConfirmModal);
            document.getElementById('cancel-delete').addEventListener('click', closeConfirmModal);
            document.getElementById('confirm-delete').addEventListener('click', deleteCustomer);
            
            // Закрытие модальных окон при клике вне их
            document.getElementById('customer-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('customer-modal')) {
                    closeCustomerModal();
                }
            });
            
            document.getElementById('confirm-modal').addEventListener('click', (e) => {
                if (e.target === document.getElementById('confirm-modal')) {
                    closeConfirmModal();
                }
            });
            
            // Фильтры и поиск
            document.getElementById('search-customers').addEventListener('input', (e) => {
                crmState.searchQuery = e.target.value;
                filterAndSortCustomers();
            });
            
            document.getElementById('filter-status').addEventListener('change', (e) => {
                crmState.statusFilter = e.target.value;
                filterAndSortCustomers();
            });
            
            document.getElementById('sort-customers').addEventListener('change', (e) => {
                crmState.sortOption = e.target.value;
                filterAndSortCustomers();
            });
            
            // Воронка продаж
            document.getElementById('funnel-period').addEventListener('change', (e) => {
                crmState.funnelPeriod = e.target.value;
                renderFunnel();
            });
            
            // Кнопка "Показать еще"
            document.getElementById('load-more').addEventListener('click', () => {
                crmState.currentPage++;
                renderCustomers();
                updatePagination();
            });
        }
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', initCRM);
    </script>
</body>
</html>
